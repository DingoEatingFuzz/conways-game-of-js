<!doctype html>
<html>
<head>
    <meta charset='utf-8'/>
    <script src='jlife.js'></script>
    <div id='game-box'>
        <canvas id='game'></canvas>
        <canvas id='game-grid'></canvas>
    </div>
    <style>
        html, body { margin:0; padding:0; height:100%; }
        #game-box { position:relative; margin:auto; }
        #game, #game-grid { position:absolute; top:0; left:0; }
        #game, #game-grid, #game-box { width:100%; height:100%; }
    </style>
</head>
<body>
    <script>
        var squareSize = parseInt(location.hash.substr(1)) || 4;

        var gameCanvas = document.getElementById('game');
        var gridCanvas = document.getElementById('game-grid');
            gameCanvas.width  = gridCanvas.width  = document.width;
            gameCanvas.height = gridCanvas.height = document.height;
        var loop;

        initGame(gameCanvas, gridCanvas, squareSize);

        window.onhashchange = function() {
            squareSize = parseInt(location.hash.substr(1)) || 4;
            initGame(gameCanvas, gridCanvas, squareSize);
        }

        function canvasPrintBoard(board, ctx) {
            imageData = ctx.createImageData(board.width, board.height);
            for (var i = 0, len = board.cells.length; i < len; ++i) {
                var idx = i * 4;
                var color = board.cells[i] ? 0 : 255;
                imageData.data[idx]   = imageData.data[idx+1] = imageData.data[idx+2] = color;
                imageData.data[idx+3] = 255;
            }
            ctx.putImageData(imageData, 0, 0);
        }

        function canvasBigPrintBoard(board, ctx, size) {
            ctx.fillStyle = '#FFF';
            ctx.fillRect(0, 0, board.width * size, board.height * size);
            ctx.fillStyle = '#09F';
            for (var i = 0, len = board.cells.length; i < len; ++i) {
                var x = i % board.width, y = Math.floor(i / board.width);
                if (board.cells[i]) ctx.fillRect(x * size, y * size, size, size);
            }
        }

        function printBoard(board) {
            console.log(
                board.cells.toString()
                    .replace(/,/g, '')
                    .replace(/(\d{50})/g, '$1\n')
                    .replace(/0/g, ' ')
                    .replace(/1/g, 'X')
            );
        }

        function initGrid(canvas, size) {
            size = size || 10;
            ctx  = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (size > 3) {
                ctx.strokeStyle = '#CCC';
                ctx.lineWidth   = 1;
                ctx.beginPath();
                for (var i = 0, len = canvas.width; i <= len; i += size) {
                    ctx.moveTo(i, 0);
                    ctx.lineTo(i, canvas.height);
                }
                for (i = 0, len = canvas.height; i <= len; i += size) {
                    ctx.moveTo(0, i);
                    ctx.lineTo(canvas.width, i);
                }
                ctx.stroke();
                ctx.closePath();
            }
        }

        function initGame(gameCanvas, gridCanvas, size) {
            kill();

            var ctx = gameCanvas.getContext('2d');
            ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);

            var board = JLife(Math.floor(gameCanvas.width / size), Math.floor(gameCanvas.height / size));
            initGrid(gridCanvas, size);

            loop = setInterval(function() {
                board.step();
                canvasBigPrintBoard(board, ctx, size);
            }, 1000/25);
        }

        function kill() {
            clearInterval(loop);
        }
    </script>
</body>
</html>